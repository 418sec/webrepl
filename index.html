<html>
    <head>
        <title>Node REPL</title>
        <link rel="stylesheet" href="webrepl.css" TYPE="text/css"/>
        <script src="jquery-1.5.min.js" type="text/javascript"></script>
        
        <script type="text/javascript">
            
            var blurbHidden = false;
            
            $(document).ready(function() {
                $('#in').keypress(function(event) {
                    var keyCode = event.keyCode || event.which;
                    if (keyCode === 13) {
                        event.preventDefault();
                        commandEntered();
                    } 
                });
                
                $('#in').keydown(function(event) {
                    var keyCode = event.keyCode || event.which;
                    if (keyCode === 9) {
                        event.preventDefault();
                        complete();
                    }
                });
                
                $('#clear').width('100px');
                $('#clear').click(function() {
                    clear();
                });
                
                $.get('info', function(data) {
                    $('#header').prepend($("<div>[" + data.pid + '] ' + data.name + "</div>"));
                }, 'json');
                
                $('#in').focus();
            });
            
            function clear() {
                $.post('clear', function(data) {
                    getResponse();
                });
                $('#out').prepend($("<div class='replErr'>[ reset ]</div>"));
            }
            
            function commandEntered() {
                if (! blurbHidden) {
                    $('#blurb').hide();
                    blurbHidden = true;
                }
                var command = $('#in').val();
                $('#out').prepend($("<div class='replIn'>" + command + "</div>"));
                $.post('repl', command, function(data) {
                    $('#in').val('');
                    getResponse();
                }, "text");
            }
            
            function getResponse() {
                $.get('repl', function(resData) {
                    var type = 'replOut';
                    if (resData.match(/.*Error:/)) {
                        type = 'replErr';
                    }
                    $('#out').prepend($("<div class='" + type + "'>" + resData + "</div>"));
                });
            }
            
            function complete() {
                var str = $('#in').val();
                var i = str.lastIndexOf(' ');
                var word = str.substr(i + 1);
                
                $.get('complete/' + word, function(data) {
                    if (data.completions.length == 1) {
                        var sWord = data.completions[0];
                        $('#in').val($('#in').val() + lettersToAppend(word, sWord));
                    } else {
                        var possibles = [];
                        for (j = 0; j < data.completions.length; j++) {
                            if (data.completions[j] != '') {
                                possibles.push(data.completions[j]);
                            }
                        }
                        var suggestString = '';
                        for (j = 0; j < possibles.length; j++) {
                            suggestString += possibles[j] + ' ';
                        }
                        if (! blurbHidden) {
                            $('#blurb').hide();
                            blurbHidden = true;
                        }
                        $('#out').prepend($("<div class='replCompl'>" + suggestString + "</div>"));
                    }
                }, "json"); 
            }
            
            function lettersToAppend(word1, word2) {
                var word1Matched = 0;
                for (i = 0; i < word1.length + word2.length; i++) {
                    if (word1[i] === word2[word1Matched]) {
                        word1Matched++;
                        if ((i+1) == word1.length) {
                            return word2.substring(word1Matched);
                        }
                    } else {
                        word1Matched = 0;
                    }
                }
            }
            
            function longestInCommon(candidates, index) {
              var i, ch, memo
              do {
                memo = null
                for (i=0; i < candidates.length; i++) {
                  ch = candidates[i].charAt(index)
                  if (!ch) break
                  if (!memo) memo = ch
                  else if (ch != memo) break
                }
              } while (i == candidates.length && ++index)

              return candidates[0].slice(0, index)
            }
            
        </script>
    </head>
    <body>
        <div id="header"></div>
        <table id="input-bar">
            <tr>
                <td style="width:95%"><input id="in" type="text" /></td>
                <td style="width:5%"><span id="clear">^C</span></td>
            </tr>
        </table>
        <div id="main-container">
            <div id="out"><div id="blurb">web-repl: Type commands in the above box to execute in this javascript process. Use tab for completion.</div></div>
        </div>
    </body>
</html>
